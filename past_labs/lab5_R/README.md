# Lab 5

All of the commands run in this lab can be run using a `Makefile` in the root of the submission directory.

The submission contains our final layout files for easy inspection, so there should be no need to run any of the commands below to view our results.

If desired, our results can be cleared using `make clean` and recreated by running `make all` in the root directory.

Each part can be run individually by running `make part1`, `make part2`, or `make part3`.

Note: running `make all` will take several minutes to complete since this includes running `TritonRoute` on all of the part 2 test cases.
Since part 2 is not needed to make the final layout, running `make route` is the same as running part 1 and part 3 but skipping part 2.
Running `make route` will output the final layout into `final_layout/accum_routed.mag`.

More details about each step are below, but here is a summary of where the files are for everything:

- Final `.mag` files for each gate are in `final_layout`
- Part 1 cell layout is saved to `final_layout/accum.mag`
- Part 2 test layouts with only power and ground are saved to `part2/GATE/testN.mag` where `GATE` is the name of the gate, and `N` is the test number for that cell
- Part 2 test layouts with all routing are saved to `part2/GATE/testNrouted.mag` where `GATE` is the name of the gate, and `N` is the test number for that cell
- The ACT test files for part 2 are saved to `part2/GATE/test.act` where `GATE` is the name of the gate
- The interact scripts used for part 2 testing are saved to `part2/GATE/testN.mag` where `GATE` is the name of the gate, and `N` is the test number for that cell
  - These are really just symlinks to the `testN.scr` files located in `part2/templates`
- Part 3 final routed layout is saved to `final_layout/accum_routed.mag`
- The interact script for parts 1 and 2 is called `interact.scr`

Note: the `magic_cmds` file is copied directly from the one provided on the course website, and the `Makefile`s are based on the one available from the website (but with heavy modifications).

## Part 1 - Re-importing cell layout

The final `.mag` files created in this part can be found in `final_layout`.

The layout generated in this part is saved to `final_layout/accum.mag`, and can be opened as usual in `magic`.

Also in `final_layout` are the `output.lef` and `output.def` files generated by the interact script.

The interact script used is located in the submission root and is called `interact.scr`.
The script is also symlinked into the `part1` directory as `part1/interact.scr`.
Note: the script is the same one used for part 3, so it also includes the lines that run the routing.

The `magic` script used is in the `Makefile` on lines 75 and 80.
More details are below.

The part 1 output files are also symlinked into the `part1` directory.

### Commands to reproduce our results

To run part 1, simply run `make part1` from the submission root directory.
This will do the following:

1. Create `.rect` files in the `mag` directory for each gate, using the `.mag` files in that directory
2. Run the interact script to populate `final_rect` with the final rect files and also create `output.lef` and `output.def`.
3. Convert the `.rect` files in `final_rect` into `.tcl` files
4. Load those `.tcl` files into magic, and save them as `.mag` files in the `final_layout` directory
5. Copy the `output.lef` and `output.def` files from the root into the `final_layout` directory
6. Load the gates, `output.lef`, and `output.def` files into magic and save the accumulator layout as `accum.mag` in the `final_layout` directory

To view that part 1 has been done correctly, open the accumulator layout using `magic final_layout/accum.mag`.
The individual gates can also be opened using `magic final_layout/GATE.mag`.

The `Makefile` contains the commands used to create the final `.mag` files, but they are copied hee for convenience:

- `mag2rect_sky130.py mag/GATE.mag > mag/GATE.rect` to convert the gate layouts back to `.rect` files
- `mag.pl -prboundary final_rect/GATE.rect > final_layout/GATE.tcl` to convert the final `.rect` files into the final `.tcl` files
- `./magic_cmds GATE "source final_layout/GATE.tcl; save final_layout/GATE"` to create `.mag` files from the final `.rect` files
- `./magic_cmds accum "lef read final_layout/output.lef; def read final_layout/output.def; save final_layout/accum"` to create the accumulator layout

## Part 2 - Routing-friendly cell layout

Each cell has a test setup called `test.act` inside the corresponding cell directory of `part2`.
The `test.act` file contains between 1 and 6 process definitions called `test1` through `test6`.
Each test corresponds to a different input/output pair that get linked together.

Each cell has corresponding test scripts labeled `test1.scr` to `test6.scr`.
These scrips are identical, except that they load in the corresponding test process and output numbered `.lef`, `.def`, and `.guide` files.

Note: the script files are actually symlinks to corresponding files in the `part2/templates` directory, to make changing the test scripts across the board easier.
All of the scripts use a density of 0.5.

For example, the `_0_0std_0_0cells_0_0AND2X1` cell has 2 inputs and 1 output, so it only needs to have two test scrips.
It will has `test1.scr` that creates `output1.lef`. `output1.def`, and `output1.guide` for the `test1` process.
It will has `test2.scr` that creates `output2.lef`. `output2.def`, and `output2.guide` for the `test2` process.

`TritonRoute` is run for each test to create `routed1.def` through `routed6.def` (as many as needed for the given cell).

Finally, each cell has power layouts called `test1.mag` through `test6.mag`, and fully routed layouts called `test1routed.mag` through `test6routed.mag`.

To view the final routed layouts for a given cell, simply run `magic part2/GATE/test1routed.mag` (obviously replacing `1` with the corresponding test number).

### Commands to reproduce our results

All of the commands to run the interact scripts and generate the layouts for part 2 can be done using makefiles.
Each cell directory has a `Makefile` inside that can be used to run the tests for that cell.

From within a cell's directory (i.e. `part2/GATE`), run `make` (or `make all`) to make tests for all of the layouts.
Running `make` will do the following:

1. Copy the gate `.mag` file from `final_layout` into the current directory
2. Copy the well tap `.mag` file into the current directory
3. Run each test's interact script to create the various `outputN.lef`, `outputN.def`, and `outputN.guide` files
4. Run `TritonRoute` for each test to create the various `routedN.def` files
5. Create power/ground layouts and save them as `testN.mag` where `N` is the test number
6. Create fully routed layouts and save them as `testNrouted.mag` where `N` is the test number

Test can be run one at a time using `make testN.mag` and `make testNrouted.mag` where `N` is the desired test number.

Run `make prepare` to remove all extra files like `.log` files and other non-essentials.
This will leave the final `.mag` files, the `.lef`, `.def`, and `.guides` files, `.scr`, and `.act` files.
This is the command that was run to prepare for submission.

Run `make clean` to remove all generated files and restart.

All of the part 2 tests can be run together by running `make part2` in the root directory.

## Part 3 - Place and route

The final places and routed layout file is `final_layout/accum_routed.mag`.
It can be viewed by running `magic final_layout/accum_routed`, and then expanding everything.
To hide the labels and make viewing easier, run `see no labels` in `magic`.

The part 3 output files are also symlinked into the `part3` directory.

### Commands to reproduce our results

To regenerate the layout file, run `make part3` from the root directory.
The `Makefile` runs the following:

The interact script used is called `interact.scr` in the root directory.
It is the same script used for part 1.

The `TritonRoute` command used for the final layout is `TritonRoute -lef output.lef -def output.def -guide output.guide -output routed.def`.

The final layout is loaded into magic using: `./magic_cmds accum_routed "lef read final_layout/output.lef; def read final_layout/routed.def; save final_layout/accum_routed"`.
